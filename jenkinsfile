def env = "testing"

@NonCPS 
def setDescription() { 
    try {
        def item = Jenkins.instance.getItemByFullName("Test WinAgent")
        if (item) {
            println "Found the job"
            item.setDescription("This description was changed by script")
            item.save()
        } else {
            pritln "Didn't find object woth this name"
        }
        
        //item.setDescription("This description was changed by script") 
        //item.save()
    } catch  (Exception e) {
        println 'inside catch block!!!'
        println "I caught e: ${e.message}"
    }
}


pipeline {
    agent {label 'WinAgent2016'}
    stages {
        stage('build') {
            steps {
                echo 'stage build, env = ' + env
                //bat 'python --version'
                bat 'java -version'
                bat 'dir'
                //bat 'git status'
                script{
                    setDescription()
                }
            }
            post {
                success {
                    echo "Only when we haven't failed running the first stage"
                }
                failure {
                    echo "Only when we fail running the first stage."
                }
            }
        }
        stage('test') {
            agent {label 'master'}
            steps {
                echo 'stage test'
                sh 'python --version'
                sh 'ls'
                //bat "exit 1"   used to check failure
                script {
                    try {
                        setDescription()
                    } catch (Exception e) {
                        println 'inside catch block!!!'
                        println "I caught e: ${e.message}"
                    } finally {
                        //println 'inside finally block'
                    }                    
                }
            }
        }
        stage('deploy') {
            steps {
                //sh 'sudo docker run -d -p 80:80 ittaihurvitz/simple-container-ittai:1.0'
                echo 'stage deploy'
            }
        }
    }
    post { 
        always { 
            echo 'Post at the end of all stages'
        }
        success {
            echo "Only when success"
        }
        failure {
            echo "Only when fail"
        }
    }
}